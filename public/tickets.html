<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Tracking Sheet</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüé´%3C/text%3E%3C/svg%3E">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .sheet-container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .sheet-header {
            background: #1a73e8;
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sheet-title {
            font-size: 1.5em;
            font-weight: 500;
            margin: 0;
        }
        
        .sheet-subtitle {
            font-size: 0.9em;
            opacity: 0.9;
            margin: 5px 0 0 0;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        .status-indicator.disconnected {
            background: #f44336;
            animation: none;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .add-ticket-btn {
            background: #34a853;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: background 0.2s ease;
        }
        
        .add-ticket-btn:hover {
            background: #2d8f44;
        }

        .add-ticket-btn:disabled {
            background: #9e9e9e;
            cursor: not-allowed;
        }
        
        .export-btn {
            background: #ff9800;
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background 0.2s ease;
        }
        
        .export-btn:hover {
            background: #f57c00;
        }
        
        .delete-all-btn {
            background: #f44336;
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background 0.2s ease;
        }
        
        .delete-all-btn:hover {
            background: #d32f2f;
        }

        .refresh-btn {
            background: #2196f3;
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background 0.2s ease;
        }
        
        .refresh-btn:hover {
            background: #1976d2;
        }
        
        .search-container {
            padding: 15px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dadce0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 0.9em;
            background: white;
        }
        
        .search-input:focus {
            outline: 2px solid #1a73e8;
            border-color: #1a73e8;
        }
        
        .clear-search-btn {
            background: #f8f9fa;
            border: 1px solid #dadce0;
            color: #3c4043;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .clear-search-btn:hover {
            background: #e8f0fe;
        }

        .loading-indicator {
            display: none;
            padding: 20px;
            text-align: center;
            color: #1a73e8;
            font-weight: 500;
        }

        .loading-indicator.show {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            display: none;
            padding: 15px 30px;
            background: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
            font-weight: 500;
        }

        .error-message.show {
            display: block;
        }
        
        .sheet-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            font-weight: 400;
        }
        
        .sheet-table th {
            background: #f8f9fa;
            border: 1px solid #dadce0;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #3c4043;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .sheet-table td {
            border: 1px solid #dadce0;
            padding: 10px 16px;
            vertical-align: middle;
            line-height: 1.4;
            font-size: 13px;
        }
        
        .sheet-table tr:hover {
            background: #f8f9fa;
        }
        
        .sheet-table tr:nth-child(even) {
            background: #fafafa;
        }
        
        .sheet-table tr:nth-child(even):hover {
            background: #f0f0f0;
        }
        
        .sheet-table tr.hidden {
            display: none;
        }

        .sheet-table tr.saving {
            background: #fff3e0 !important;
        }

        .sheet-table tr.error {
            background: #ffebee !important;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            min-width: 60px;
            display: inline-block;
            letter-spacing: 0.3px;
        }
        
        .status-open {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: #c62828;
            border: 1px solid #ef5350;
            box-shadow: 0 1px 3px rgba(244, 67, 54, 0.2);
        }
        
        .status-resolved {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            color: #2e7d32;
            border: 1px solid #66bb6a;
            box-shadow: 0 1px 3px rgba(76, 175, 80, 0.2);
        }
        
        .status-pending {
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
            color: #f57c00;
            border: 1px solid #ffb74d;
            box-shadow: 0 1px 3px rgba(255, 152, 0, 0.2);
        }
        
        .status-on-hold {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            color: #7b1fa2;
            border: 1px solid #ba68c8;
            box-shadow: 0 1px 3px rgba(156, 39, 176, 0.2);
        }
        
        .status-on-hold-escalated-bug {
            background: linear-gradient(135deg, #fce4ec, #f8bbd9);
            color: #ad1457;
            border: 1px solid #ec407a;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(233, 30, 99, 0.3);
            animation: pulse-urgent 2s infinite;
        }
        
        .status-escalated-csm {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1565c0;
            border: 1px solid #42a5f5;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(33, 150, 243, 0.2);
        }
        
        .status-misrouted {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            color: #ef6c00;
            border: 1px solid #ff9800;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(255, 152, 0, 0.2);
        }

        @keyframes pulse-urgent {
            0% { box-shadow: 0 2px 4px rgba(233, 30, 99, 0.3); }
            50% { box-shadow: 0 2px 8px rgba(233, 30, 99, 0.5); }
            100% { box-shadow: 0 2px 4px rgba(233, 30, 99, 0.3); }
        }
        
        .category-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-align: center;
            min-width: 40px;
            display: inline-block;
            letter-spacing: 0.2px;
            text-transform: uppercase;
        }
        
        .category-question {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .category-bug {
            background: #ffebee;
            color: #c62828;
        }
        
        .category-feedback {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .queue-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-align: center;
            min-width: 30px;
            display: inline-block;
            letter-spacing: 0.3px;
        }
        
        .queue-vip {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .queue-cplus {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        /* Product Badge Styles */
        .product-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            letter-spacing: 0.2px;
            border: 1px solid transparent;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Core Platform Products - Blue tones */
        .product-api, .product-community, .product-space, .product-spaces, .product-space-groups {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #0d47a1;
            border-color: #2196f3;
        }

        /* Apps & Integration Products - Green tones */
        .product-3rd-party-apps, .product-circle-apps, .product-circle-plus-app, .product-custom-builder-app, .product-desktop-app, .product-integrations {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            color: #1b5e20;
            border-color: #4caf50;
        }

        /* Content & Learning Products - Purple tones */
        .product-courses, .product-circle-academy, .product-posts, .product-post, .product-image-spaces {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            color: #4a148c;
            border-color: #9c27b0;
        }

        /* Communication Products - Orange tones */
        .product-messaging, .product-notifications, .product-email-hub, .product-live-stream, .product-events, .product-circle-events {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            color: #e65100;
            border-color: #ff9800;
        }

        /* Admin & Business Products - Red tones */
        .product-admin-billing, .product-members-billing, .product-analytics, .product-audience, .product-paywalls, .product-workflows {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: #b71c1c;
            border-color: #f44336;
        }

        /* Technical & Infrastructure Products - Teal tones */
        .product-dev-ops, .product-security, .product-single-sign-on, .product-custom-domain, .product-data-export, .product-sandbox {
            background: linear-gradient(135deg, #e0f2f1, #b2dfdb);
            color: #004d40;
            border-color: #009688;
        }

        /* Design & UI Products - Pink tones */
        .product-design, .product-circle-embed-widgets, .product-whitelabel-branded-email, .product-general-settings {
            background: linear-gradient(135deg, #fce4ec, #f8bbd9);
            color: #880e4f;
            border-color: #e91e63;
        }

        /* Support & Discovery Products - Cyan tones */
        .product-circle-community, .product-discover, .product-circle-error-codes, .product-community-access {
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
            color: #006064;
            border-color: #00bcd4;
        }

        /* AI & Special Products - Indigo tones */
        .product-ai-agent {
            background: linear-gradient(135deg, #e8eaf6, #c5cae9);
            color: #1a237e;
            border-color: #3f51b5;
            font-weight: 700;
        }

        /* Utility & Import Products - Brown tones */
        .product-bulk-import-space, .product-bulk-import-space-group, .product-easycsv, .product-login {
            background: linear-gradient(135deg, #efebe9, #d7ccc8);
            color: #3e2723;
            border-color: #795548;
        }

        /* Sales & Marketing Products - Deep Orange tones */
        .product-sales, .product-promo, .product-sdr {
            background: linear-gradient(135deg, #fbe9e7, #ffccbc);
            color: #bf360c;
            border-color: #ff5722;
        }

        /* Miscellaneous Products - Grey tones */
        .product-misc {
            background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
            color: #424242;
            border-color: #757575;
        }

        /* Dynamic Status Dropdown Styling */
        .status-dropdown {
            transition: all 0.3s ease;
        }

        .status-dropdown[data-status="Open"] {
            background: #ffebee !important;
            color: #c62828 !important;
            font-weight: 600 !important;
            border-color: #f44336 !important;
        }

        .status-dropdown[data-status="Pending"] {
            background: #fff8e1 !important;
            color: #f57c00 !important;
            font-weight: 600 !important;
            border-color: #ff9800 !important;
        }

        .status-dropdown[data-status="Resolved"] {
            background: #e8f5e8 !important;
            color: #2e7d32 !important;
            font-weight: 600 !important;
            border-color: #4caf50 !important;
        }

        .status-dropdown[data-status="On Hold (Asking Dev Team)"] {
            background: #f3e5f5 !important;
            color: #7b1fa2 !important;
            font-weight: 600 !important;
            border-color: #9c27b0 !important;
        }

        .status-dropdown[data-status="On Hold Escalated (Bug)"] {
            background: #fce4ec !important;
            color: #ad1457 !important;
            font-weight: 700 !important;
            border-color: #e91e63 !important;
            box-shadow: 0 0 5px rgba(233, 30, 99, 0.3) !important;
        }

        .status-dropdown[data-status="Escalated (CSM)"] {
            background: #e3f2fd !important;
            color: #1565c0 !important;
            font-weight: 600 !important;
            border-color: #2196f3 !important;
        }

        .status-dropdown[data-status="Misrouted"] {
            background: #fff3e0 !important;
            color: #ef6c00 !important;
            font-weight: 600 !important;
            border-color: #ff9800 !important;
        }

        /* Dynamic Product Dropdown Styling */
        .product-dropdown {
            transition: all 0.3s ease;
        }

        .product-dropdown[data-category="core"] {
            background: #e3f2fd !important;
            color: #0d47a1 !important;
            border-color: #2196f3 !important;
        }

        .product-dropdown[data-category="apps"] {
            background: #e8f5e8 !important;
            color: #1b5e20 !important;
            border-color: #4caf50 !important;
        }

        .product-dropdown[data-category="content"] {
            background: #f3e5f5 !important;
            color: #4a148c !important;
            border-color: #9c27b0 !important;
        }

        .product-dropdown[data-category="communication"] {
            background: #fff3e0 !important;
            color: #e65100 !important;
            border-color: #ff9800 !important;
        }

        .product-dropdown[data-category="admin"] {
            background: #ffebee !important;
            color: #b71c1c !important;
            border-color: #f44336 !important;
        }

        .product-dropdown[data-category="technical"] {
            background: #e0f2f1 !important;
            color: #004d40 !important;
            border-color: #009688 !important;
        }

        .product-dropdown[data-category="design"] {
            background: #fce4ec !important;
            color: #880e4f !important;
            border-color: #e91e63 !important;
        }

        .product-dropdown[data-category="support"] {
            background: #e0f7fa !important;
            color: #006064 !important;
            border-color: #00bcd4 !important;
        }

        .product-dropdown[data-category="ai"] {
            background: #e8eaf6 !important;
            color: #1a237e !important;
            border-color: #3f51b5 !important;
            font-weight: 700 !important;
        }

        .product-dropdown[data-category="utility"] {
            background: #efebe9 !important;
            color: #3e2723 !important;
            border-color: #795548 !important;
        }

        .product-dropdown[data-category="sales"] {
            background: #fbe9e7 !important;
            color: #bf360c !important;
            border-color: #ff5722 !important;
        }

        .product-dropdown[data-category="misc"] {
            background: #f5f5f5 !important;
            color: #424242 !important;
            border-color: #757575 !important;
        }

        /* Colored Dropdown Options */
        .status-dropdown option[value="Open"] {
            background: #ffebee;
            color: #c62828;
            font-weight: 600;
        }

        .status-dropdown option[value="Pending"] {
            background: #fff8e1;
            color: #f57c00;
            font-weight: 600;
        }

        .status-dropdown option[value="Resolved"] {
            background: #e8f5e8;
            color: #2e7d32;
            font-weight: 600;
        }

        .status-dropdown option[value="On Hold (Asking Dev Team)"] {
            background: #f3e5f5;
            color: #7b1fa2;
            font-weight: 600;
        }

        .status-dropdown option[value="On Hold Escalated (Bug)"] {
            background: #fce4ec;
            color: #ad1457;
            font-weight: 700;
        }

        .status-dropdown option[value="Escalated (CSM)"] {
            background: #e3f2fd;
            color: #1565c0;
            font-weight: 600;
        }

        .status-dropdown option[value="Misrouted"] {
            background: #fff3e0;
            color: #ef6c00;
            font-weight: 600;
        }

        /* Product Dropdown Colors */
        .product-dropdown option {
            padding: 8px 12px;
            font-weight: 500;
        }

        /* Core Platform Products - Blue */
        .product-dropdown option[value*="API"], 
        .product-dropdown option[value*="Community"],
        .product-dropdown option[value*="Space"] {
            background: #e3f2fd;
            color: #0d47a1;
        }

        /* Apps & Integration - Green */
        .product-dropdown option[value*="Apps"], 
        .product-dropdown option[value*="App"],
        .product-dropdown option[value*="Integrations"] {
            background: #e8f5e8;
            color: #1b5e20;
        }

        /* Content & Learning - Purple */
        .product-dropdown option[value*="Courses"], 
        .product-dropdown option[value*="Academy"],
        .product-dropdown option[value*="Posts"],
        .product-dropdown option[value*="Post"],
        .product-dropdown option[value*="Image"] {
            background: #f3e5f5;
            color: #4a148c;
        }

        /* Communication - Orange */
        .product-dropdown option[value*="Messaging"], 
        .product-dropdown option[value*="Notifications"],
        .product-dropdown option[value*="Email"],
        .product-dropdown option[value*="Live"],
        .product-dropdown option[value*="Events"] {
            background: #fff3e0;
            color: #e65100;
        }

        /* Admin & Business - Red */
        .product-dropdown option[value*="Billing"], 
        .product-dropdown option[value*="Analytics"],
        .product-dropdown option[value*="Audience"],
        .product-dropdown option[value*="Paywalls"],
        .product-dropdown option[value*="Workflows"] {
            background: #ffebee;
            color: #b71c1c;
        }

        /* Technical - Teal */
        .product-dropdown option[value*="Dev"], 
        .product-dropdown option[value*="Security"],
        .product-dropdown option[value*="Sign-On"],
        .product-dropdown option[value*="Domain"],
        .product-dropdown option[value*="Export"],
        .product-dropdown option[value*="Sandbox"] {
            background: #e0f2f1;
            color: #004d40;
        }

        /* Design & UI - Pink */
        .product-dropdown option[value*="Design"], 
        .product-dropdown option[value*="Widgets"],
        .product-dropdown option[value*="Whitelabel"],
        .product-dropdown option[value*="Settings"] {
            background: #fce4ec;
            color: #880e4f;
        }

        /* Support & Discovery - Cyan */
        .product-dropdown option[value*="Discover"], 
        .product-dropdown option[value*="Error"],
        .product-dropdown option[value*="Access"] {
            background: #e0f7fa;
            color: #006064;
        }

        /* AI & Special - Indigo */
        .product-dropdown option[value*="AI"] {
            background: #e8eaf6;
            color: #1a237e;
            font-weight: 700;
        }

        /* Utility & Import - Brown */
        .product-dropdown option[value*="Import"], 
        .product-dropdown option[value*="CSV"],
        .product-dropdown option[value*="Login"] {
            background: #efebe9;
            color: #3e2723;
        }

        /* Sales & Marketing - Deep Orange */
        .product-dropdown option[value*="Sales"], 
        .product-dropdown option[value*="Promo"],
        .product-dropdown option[value*="SDR"] {
            background: #fbe9e7;
            color: #bf360c;
        }

        /* Misc - Grey */
        .product-dropdown option[value*="Misc"] {
            background: #f5f5f5;
            color: #424242;
        }
        
        .editable-cell {
            background: #fff;
            border: 1px solid #dadce0;
            padding: 8px;
            border-radius: 4px;
            font-family: inherit;
            font-size: inherit;
            width: 100%;
            box-sizing: border-box;
        }
        
        .editable-cell:focus {
            outline: 2px solid #1a73e8;
            border-color: #1a73e8;
        }
        
        .date-cell {
            color: #1a73e8;
            font-size: 12px;
            font-weight: 600;
            line-height: 1.3;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', monospace;
        }
        
        .date-time {
            color: #5f6368;
            font-size: 10px;
            font-weight: 500;
            display: block;
            margin-top: 2px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segui UI', sans-serif;
        }
        
        .ticket-number {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-weight: 600;
            color: #1a73e8;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        
        .add-row-form {
            background: #f8f9fa;
            padding: 20px;
            border-top: 1px solid #dadce0;
            display: none;
        }
        
        .add-row-form.active {
            display: block;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
            align-items: end;
        }
        
        .form-label {
            font-weight: 500;
            color: #3c4043;
        }
        
        .form-input {
            padding: 10px 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 0.9em;
            width: 100%;
            box-sizing: border-box;
        }
        
        .form-select {
            padding: 10px 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            background: white;
            font-size: 0.9em;
            width: 100%;
            box-sizing: border-box;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
        }
        
        .btn-primary {
            background: #1a73e8;
            color: white;
        }

        .btn-primary:disabled {
            background: #9e9e9e;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #3c4043;
            border: 1px solid #dadce0;
        }
        
        .sheet-stats {
            display: flex;
            gap: 30px;
            padding: 15px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dadce0;
            font-size: 0.85em;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }
        
        .stat-item:hover {
            background-color: #e8f0fe;
        }
        
        .stat-item.active {
            background-color: #1a73e8;
            color: white;
        }
        
        .stat-item.active .stat-label,
        .stat-item.active .stat-value {
            color: white;
        }
        
        .stat-item.non-clickable {
            cursor: default;
        }
        
        .stat-item.non-clickable:hover {
            background-color: transparent;
        }
        
        .stat-label {
            color: #5f6368;
        }
        
        .stat-value {
            font-weight: 600;
            color: #3c4043;
        }
        
        .actions-cell {
            text-align: center;
            white-space: nowrap;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: #1a73e8;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            letter-spacing: 0.2px;
            display: inline-block;
            margin: 0 2px;
        }
        
        .action-btn:hover {
            background: #e8f0fe;
        }

        .action-btn:disabled {
            color: #9e9e9e;
            cursor: not-allowed;
        }
        
        .delete-btn {
            color: #d93025 !important;
            margin-left: 5px;
        }
        
        .delete-btn:hover:not(:disabled) {
            background: #fce8e6 !important;
        }

        .escalation-link {
            color: #1976d2;
            text-decoration: none;
            font-size: 11px;
            font-weight: 500;
        }
        
        .escalation-link:hover {
            text-decoration: underline;
        }
        
        .duplicate-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            color: #856404;
            font-size: 0.9em;
            display: none;
        }
        
        .duplicate-warning.show {
            display: block;
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 12px 16px;
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            z-index: 1000;
        }

        .sync-status.show {
            display: flex;
        }

        .sync-status.success {
            border-left: 4px solid #4caf50;
            color: #2e7d32;
        }

        .sync-status.error {
            border-left: 4px solid #f44336;
            color: #c62828;
        }

        .sync-status.saving {
            border-left: 4px solid #ff9800;
            color: #ef6c00;
        }

        /* Escalated Bug Workflow Styles */
        .escalated-bug-fields {
            display: none;
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            grid-column: 1 / -1;
        }

        .escalated-bug-fields.show {
            display: block;
        }

        .escalated-bug-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .escalated-bug-fields .form-input,
        .escalated-bug-fields .form-select {
            padding: 8px 12px;
            border: 1px solid #ff9800;
            border-radius: 4px;
            background: white;
        }

        .escalated-bug-fields .form-input:focus,
        .escalated-bug-fields .form-select:focus {
            outline: 2px solid #ff9800;
            border-color: #ff9800;
        }

        .escalated-bug-fields textarea {
            width: 100%;
            min-height: 80px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="sheet-container">
        <div class="sheet-header">
            <div>
                <h1 class="sheet-title">Support Ticket Tracking</h1>
                <p class="sheet-subtitle">Track and manage support tickets efficiently</p>
                <div class="connection-status">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="connectionStatus">Connected to Database</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="refresh-btn" onclick="loadTicketsFromDatabase()">üîÑ Refresh</button>
                <button class="export-btn" onclick="exportData('csv')">üìÑ Export CSV</button>
                <button class="export-btn" onclick="exportData('excel')">üìä Export Excel</button>
                <button class="delete-all-btn" onclick="deleteAllRows()">üóëÔ∏è Delete All</button>
                <button class="add-ticket-btn" onclick="toggleAddForm()" id="addTicketBtn">+ Add New Ticket</button>
            </div>
        </div>

        <div class="loading-indicator" id="loadingIndicator">
            <div class="spinner"></div>
            Loading tickets from database...
        </div>

        <div class="error-message" id="errorMessage">
            <!-- Error messages will appear here -->
        </div>
        
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="üîç Search tickets by ticket number, issue, agent, product, or status..." oninput="searchTickets()" onkeyup="searchTickets()">
            <button class="clear-search-btn" onclick="clearSearch()">Clear</button>
        </div>
        
        <div class="sheet-stats">
            <div class="stat-item" onclick="filterByStatus('all')" id="totalStat">
                <span class="stat-label">Total Tickets:</span>
                <span class="stat-value" id="totalTickets">0</span>
            </div>
            <div class="stat-item" onclick="filterByStatus('open')" id="openStat">
                <span class="stat-label">Open:</span>
                <span class="stat-value" id="openTickets">0</span>
            </div>
            <div class="stat-item" onclick="filterByStatus('pending')" id="pendingStat">
                <span class="stat-label">Pending:</span>
                <span class="stat-value" id="pendingTickets">0</span>
            </div>
            <div class="stat-item" onclick="filterByStatus('onhold')" id="onHoldStat">
                <span class="stat-label">On Hold:</span>
                <span class="stat-value" id="onHoldTickets">0</span>
            </div>
            <div class="stat-item" onclick="filterByStatus('resolved')" id="resolvedStat">
                <span class="stat-label">Resolved:</span>
                <span class="stat-value" id="resolvedTickets">0</span>
            </div>
            <div class="stat-item non-clickable">
                <span class="stat-label">Times Replied:</span>
                <span class="stat-value" id="totalTimesReplied">0</span>
            </div>
        </div>
        
        <div class="add-row-form" id="addRowForm">
            <div class="duplicate-warning" id="duplicateWarning">
                ‚ö†Ô∏è <strong>Warning:</strong> This ticket number already exists! Please check the existing ticket or use a different number.
            </div>
            
            <div class="form-row">
                <div>
                    <label class="form-label">Ticket No.</label>
                    <input type="text" class="form-input" id="newTicketNumber" placeholder="366134" onkeyup="checkDuplicateTicket()">
                </div>
                <div>
                    <label class="form-label">Issue Description</label>
                    <input type="text" class="form-input" id="newIssue" placeholder="Brief description">
                </div>
                <div>
                    <label class="form-label">Category</label>
                    <select class="form-select" id="newCategory">
                        <option value="Question">Question</option>
                        <option value="Bug">Bug</option>
                        <option value="Feedback">Feedback</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Product</label>
                    <select class="form-select product-dropdown" id="newProduct" onchange="applyProductColor(this)">
                        <option value="3rd Party Apps">3rd Party Apps</option>
                        <option value="Admin Billing">Admin Billing</option>
                        <option value="AI Agent">AI Agent</option>
                        <option value="Analytics">Analytics</option>
                        <option value="API (v1/v2/Headless)">API (v1/v2/Headless)</option>
                        <option value="Audience">Audience</option>
                        <option value="Bulk Import (Space)">Bulk Import (Space)</option>
                        <option value="Bulk Import (Space Group)">Bulk Import (Space Group)</option>
                        <option value="Circle Academy">Circle Academy</option>
                        <option value="Circle Apps">Circle Apps</option>
                        <option value="Circle Community">Circle Community</option>
                        <option value="Circle Embed Widgets">Circle Embed Widgets</option>
                        <option value="Circle Error Codes">Circle Error Codes</option>
                        <option value="Circle Events">Circle Events</option>
                        <option value="Circle Plus App">Circle Plus App</option>
                        <option value="Community">Community</option>
                        <option value="Community Access">Community Access</option>
                        <option value="Courses">Courses</option>
                        <option value="Custom Builder App">Custom Builder App</option>
                        <option value="Custom Domain">Custom Domain</option>
                        <option value="Data Export">Data Export</option>
                        <option value="Design">Design</option>
                        <option value="Desktop App">Desktop App</option>
                        <option value="Dev Ops">Dev Ops</option>
                        <option value="Discover">Discover</option>
                        <option value="EasyCSV">EasyCSV</option>
                        <option value="Email Hub">Email Hub</option>
                        <option value="Events">Events</option>
                        <option value="General Settings">General Settings</option>
                        <option value="Image Spaces">Image Spaces</option>
                        <option value="Integrations">Integrations</option>
                        <option value="Live Stream">Live Stream</option>
                        <option value="Login">Login</option>
                        <option value="Member's Billing">Member's Billing</option>
                        <option value="Messaging">Messaging</option>
                        <option value="Misc">Misc</option>
                        <option value="Notifications">Notifications</option>
                        <option value="Paywalls">Paywalls</option>
                        <option value="Post">Post</option>
                        <option value="Posts">Posts</option>
                        <option value="Promo">Promo</option>
                        <option value="Sales">Sales</option>
                        <option value="Sandbox">Sandbox</option>
                        <option value="SDR">SDR</option>
                        <option value="Security">Security</option>
                        <option value="Single Sign-On">Single Sign-On</option>
                        <option value="Space">Space</option>
                        <option value="Space Groups">Space Groups</option>
                        <option value="Spaces">Spaces</option>
                        <option value="Whitelabel (Branded Email)">Whitelabel (Branded Email)</option>
                        <option value="Workflows">Workflows</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label class="form-label">Queue</label>
                    <select class="form-select" id="newQueue">
                        <option value="C+">C+</option>
                        <option value="VIP">VIP</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Status</label>
                    <select class="form-select status-dropdown" id="newStatus" onchange="toggleEscalationFields('new'); applyStatusColor(this)">
                        <option value="Open">Open</option>
                        <option value="Pending">Pending</option>
                        <option value="Resolved">Resolved</option>
                        <option value="On Hold (Asking Dev Team)">On Hold (Asking Dev Team)</option>
                        <option value="On Hold Escalated (Bug)">On Hold Escalated (Bug)</option>
                        <option value="Escalated (CSM)">Escalated (CSM)</option>
                        <option value="Misrouted">Misrouted</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Agent</label>
                    <select class="form-select" id="newAgent">
                        <option value="">-- Select Agent (Optional) --</option>
                        <option value="Leonardo">Leonardo</option>
                        <option value="Mariana">Mariana</option>
                        <option value="Medha">Medha</option>
                        <option value="Natalia">Natalia</option>
                        <option value="Raphy">Raphy</option>
                        <option value="Roberto">Roberto</option>
                        <option value="Sam">Sam</option>
                        <option value="William">William</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Times Replied</label>
                    <input type="number" class="form-input" id="newTimesReplied" placeholder="0" min="0" value="1">
                </div>
            </div>
            
            <!-- Escalated Bug Fields (shown when "On Hold Escalated (Bug)" is selected) -->
            <div class="escalated-bug-fields" id="newEscalatedBugFields">
                <h4>üêõ Bug Escalation Details</h4>
                <div class="escalated-bug-grid">
                    <div>
                        <label class="form-label">Notion URL</label>
                        <input type="url" class="form-input" id="newNotionUrl" placeholder="https://notion.so/...">
                    </div>
                    <div>
                        <label class="form-label">Slack URL</label>
                        <input type="url" class="form-input" id="newSlackUrl" placeholder="https://slack.com/...">
                    </div>
                </div>
                <div>
                    <label class="form-label">Department</label>
                    <select class="form-select" id="newDepartment">
                        <option value="">-- Select Department --</option>
                        <option value="#feedback-cms">#feedback-cms</option>
                        <option value="#feedback-crm">#feedback-crm</option>
                        <option value="#feedback-design-systems">#feedback-design-systems</option>
                        <option value="#feedback-downtime">#feedback-downtime</option>
                        <option value="#feedback-eh">#feedback-eh</option>
                        <option value="#feedback-growth">#feedback-growth</option>
                        <option value="#feedback-infra">#feedback-infra</option>
                        <option value="#feedback-ios">#feedback-ios</option>
                        <option value="#feedback-live">#feedback-live</option>
                        <option value="#feedback-other">#feedback-other</option>
                        <option value="#feedback-paywalls">#feedback-paywalls</option>
                        <option value="#feedback-react-native-apps">#feedback-react-native-apps</option>
                        <option value="#feedback-special-projects">#feedback-special-projects</option>
                        <option value="#p-analytics">#p-analytics</option>
                        <option value="#feedback-api">#feedback-api</option>
                        <option value="#p-api-billing">#p-api-billing</option>
                    </select>
                </div>
            </div>
            
            <div class="form-buttons">
                <button class="btn btn-secondary" onclick="toggleAddForm()">Cancel</button>
                <button class="btn btn-primary" onclick="addNewTicket()" id="submitTicketBtn">Add Ticket</button>
            </div>
        </div>
        
        <table class="sheet-table">
            <thead>
                <tr>
                    <th style="width: 80px;">Actions</th>
                    <th style="width: 110px;">Date Created</th>
                    <th style="width: 90px;">Ticket #</th>
                    <th style="width: 250px;">Issue</th>
                    <th style="width: 120px;">Status</th>
                    <th style="width: 90px;">Agent</th>
                    <th style="width: 130px;">Product</th>
                    <th style="width: 70px;">Queue</th>
                    <th style="width: 80px;">Times Replied</th>
                    <th style="width: 100px;">Category</th>
                    <th style="width: 100px;">Department</th>
                    <th style="width: 80px;">Slack URL</th>
                    <th style="width: 80px;">Notion URL</th>
                    <th style="width: 180px;">Comments</th>
                    <th style="width: 110px;">Last Updated</th>
                </tr>
            </thead>
            <tbody id="ticketTableBody">
                <!-- Tickets will be loaded here from database -->
            </tbody>
        </table>
    </div>

    <!-- Sync Status Notification -->
    <div class="sync-status" id="syncStatus">
        <div class="spinner" id="syncSpinner" style="display: none;"></div>
        <span id="syncMessage">Syncing...</span>
    </div>

    <script>
        // Global variables
        let supportTickets = [];
        let currentStatusFilter = 'all';
        let isConnected = false;

        // API Functions
        async function testConnection() {
            try {
                const response = await fetch('/api/tickets');
                isConnected = response.ok;
                updateConnectionStatus();
                return isConnected;
            } catch (error) {
                isConnected = false;
                updateConnectionStatus();
                return false;
            }
        }

        function updateConnectionStatus() {
            const indicator = document.getElementById('statusIndicator');
            const status = document.getElementById('connectionStatus');
            
            if (isConnected) {
                indicator.classList.remove('disconnected');
                status.textContent = 'Connected to Database';
            } else {
                indicator.classList.add('disconnected');
                status.textContent = 'Database Connection Failed';
            }
        }

        function showSyncStatus(message, type = 'saving') {
            const syncStatus = document.getElementById('syncStatus');
            const syncMessage = document.getElementById('syncMessage');
            const syncSpinner = document.getElementById('syncSpinner');
            
            syncStatus.className = `sync-status show ${type}`;
            syncMessage.textContent = message;
            
            if (type === 'saving') {
                syncSpinner.style.display = 'inline-block';
            } else {
                syncSpinner.style.display = 'none';
            }
            
            if (type !== 'saving') {
                setTimeout(() => {
                    syncStatus.classList.remove('show');
                }, 3000);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }

        async function loadTicketsFromDatabase() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const addTicketBtn = document.getElementById('addTicketBtn');
            
            try {
                loadingIndicator.classList.add('show');
                addTicketBtn.disabled = true;
                
                const response = await fetch('/api/tickets');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                supportTickets = data.data || [];
		
                
                // Sort tickets: newest first (by database ID - most recently added)
                supportTickets.sort((a, b) => {
                    // Primary sort: by database ID - DESCENDING (newest entries have higher IDs)
                    if (a.id !== b.id) {
                        return b.id - a.id; // Newest first
                    }
                    
                    // Secondary sort: by date and time - DESCENDING
                    try {
                        const dateTimeA = new Date(a.dateCreated + ' ' + a.timeStamp);
                        const dateTimeB = new Date(b.dateCreated + ' ' + b.timeStamp);
                        return dateTimeB - dateTimeA; // Newest first
                    } catch (error) {
                        return 0;
                    }
                });
                
                renderTicketsTable();
                updateStats();
                isConnected = true;
                updateConnectionStatus();
                
            } catch (error) {
                console.error('Error loading tickets:', error);
                showError(`Failed to load tickets: ${error.message}`);
                isConnected = false;
                updateConnectionStatus();
            } finally {
                loadingIndicator.classList.remove('show');
                addTicketBtn.disabled = false;
            }
        }

        async function saveTicketToDatabase(ticketData) {
            try {
                showSyncStatus('Saving ticket...', 'saving');
                
                const response = await fetch('/api/tickets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ticketData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const savedTicket = await response.json();
		
	        showSyncStatus('Ticket saved successfully!', 'success');
                return savedTicket.data;
                
            } catch (error) {
                console.error('Error saving ticket:', error);
                showSyncStatus(`Save failed: ${error.message}`, 'error');
                throw error;
            }
        }

        async function updateTicketInDatabase(ticketId, ticketData) {
            try {
                showSyncStatus('Updating ticket...', 'saving');
                
                const response = await fetch(`/api/tickets/${ticketId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ticketData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                showSyncStatus('Ticket updated successfully!', 'success');
                return true;
                
            } catch (error) {
                console.error('Error updating ticket:', error);
                showSyncStatus(`Update failed: ${error.message}`, 'error');
                throw error;
            }
        }

        async function deleteTicketFromDatabase(ticketId) {
            try {
                showSyncStatus('Deleting ticket...', 'saving');
                
                const response = await fetch(`/api/tickets/${ticketId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                showSyncStatus('Ticket deleted successfully!', 'success');
                return true;
                
            } catch (error) {
                console.error('Error deleting ticket:', error);
                showSyncStatus(`Delete failed: ${error.message}`, 'error');
                throw error;
            }
        }

        // Helper function to safely escape HTML content
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Escalated Bug Workflow Functions
        function toggleEscalationFields(prefix) {
            const statusSelect = document.getElementById(prefix + 'Status');
            const escalatedFields = document.getElementById(prefix + 'EscalatedBugFields');
            
            if (statusSelect.value === 'On Hold Escalated (Bug)') {
                escalatedFields.classList.add('show');
            } else {
                escalatedFields.classList.remove('show');
                // Clear escalation fields when not needed
                if (prefix === 'new') {
                    document.getElementById('newNotionUrl').value = '';
                    document.getElementById('newSlackUrl').value = '';
                    document.getElementById('newDepartment').value = '';
                }
            }
        }

        // Toggle escalation fields in edit mode
        function toggleEditEscalationFields(ticketId, selectedStatus) {
            const escalationFields = document.getElementById('editEscalationFields_' + ticketId);
            const slackFields = document.getElementById('editSlackFields_' + ticketId);
            const notionFields = document.getElementById('editNotionFields_' + ticketId);
            
            if (selectedStatus === 'On Hold Escalated (Bug)') {
                // Show escalation fields
                if (escalationFields) {
                    escalationFields.style.display = 'block';
                    escalationFields.nextElementSibling.style.display = 'none';
                }
                if (slackFields) {
                    slackFields.style.display = 'block';
                    slackFields.nextElementSibling.style.display = 'none';
                }
                if (notionFields) {
                    notionFields.style.display = 'block';
                    notionFields.nextElementSibling.style.display = 'none';
                }
            } else {
                // Hide escalation fields
                if (escalationFields) {
                    escalationFields.style.display = 'none';
                    escalationFields.nextElementSibling.style.display = 'block';
                }
                if (slackFields) {
                    slackFields.style.display = 'none';
                    slackFields.nextElementSibling.style.display = 'block';
                }
                if (notionFields) {
                    notionFields.style.display = 'none';
                    notionFields.nextElementSibling.style.display = 'block';
                }
            }
        }

        // Apply status colors to dropdown
        function applyStatusColor(selectElement) {
            const selectedValue = selectElement.value;
            selectElement.setAttribute('data-status', selectedValue);
        }

        // Apply product colors to dropdown
        function applyProductColor(selectElement) {
            const selectedValue = selectElement.value;
            let category = 'misc';

            // Determine product category
            if (selectedValue.includes('API') || selectedValue.includes('Community') || selectedValue.includes('Space')) {
                category = 'core';
            } else if (selectedValue.includes('Apps') || selectedValue.includes('App') || selectedValue.includes('Integrations')) {
                category = 'apps';
            } else if (selectedValue.includes('Courses') || selectedValue.includes('Academy') || selectedValue.includes('Posts') || selectedValue.includes('Post') || selectedValue.includes('Image')) {
                category = 'content';
            } else if (selectedValue.includes('Messaging') || selectedValue.includes('Notifications') || selectedValue.includes('Email') || selectedValue.includes('Live') || selectedValue.includes('Events')) {
                category = 'communication';
            } else if (selectedValue.includes('Billing') || selectedValue.includes('Analytics') || selectedValue.includes('Audience') || selectedValue.includes('Paywalls') || selectedValue.includes('Workflows')) {
                category = 'admin';
            } else if (selectedValue.includes('Dev') || selectedValue.includes('Security') || selectedValue.includes('Sign-On') || selectedValue.includes('Domain') || selectedValue.includes('Export') || selectedValue.includes('Sandbox')) {
                category = 'technical';
            } else if (selectedValue.includes('Design') || selectedValue.includes('Widgets') || selectedValue.includes('Whitelabel') || selectedValue.includes('Settings')) {
                category = 'design';
            } else if (selectedValue.includes('Discover') || selectedValue.includes('Error') || selectedValue.includes('Access')) {
                category = 'support';
            } else if (selectedValue.includes('AI')) {
                category = 'ai';
            } else if (selectedValue.includes('Import') || selectedValue.includes('CSV') || selectedValue.includes('Login')) {
                category = 'utility';
            } else if (selectedValue.includes('Sales') || selectedValue.includes('Promo') || selectedValue.includes('SDR')) {
                category = 'sales';
            }

            selectElement.setAttribute('data-category', category);
        }

        // Initialize dropdown colors on page load
        function initializeDropdownColors() {
            // Status dropdowns
            document.querySelectorAll('.status-dropdown').forEach(select => {
                applyStatusColor(select);
                select.addEventListener('change', function() {
                    applyStatusColor(this);
                });
            });

            // Product dropdowns
            document.querySelectorAll('.product-dropdown').forEach(select => {
                applyProductColor(select);
                select.addEventListener('change', function() {
                    applyProductColor(this);
                });
            });
        }

        // UI Functions
        function renderTicketsTable() {
            const tbody = document.getElementById('ticketTableBody');
            tbody.innerHTML = '';
            
            if (supportTickets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" style="text-align: center; padding: 40px; color: #666;">No tickets found. Click "Add New Ticket" to create your first ticket.</td></tr>';
                return;
            }
            
            const statusClass = {
                'Open': 'status-open',
                'Pending': 'status-pending',
                'Resolved': 'status-resolved',
                'On Hold (Asking Dev Team)': 'status-on-hold',
                'On Hold Escalated (Bug)': 'status-on-hold-escalated-bug',
                'Escalated (CSM)': 'status-escalated-csm',
                'Misrouted': 'status-misrouted'
            };
            
            const categoryClass = {
                'Question': 'category-question',
                'Bug': 'category-bug',
                'Feedback': 'category-feedback'
            };
            
            const queueClass = {
                'VIP': 'queue-vip',
                'C+': 'queue-cplus'
            };

            // Product class mapping
            const getProductClass = (product) => {
                const productKey = product.toLowerCase()
                    .replace(/[^\w\s]/g, '') // Remove special characters
                    .replace(/\s+/g, '-')    // Replace spaces with dashes
                    .replace(/^-+|-+$/g, ''); // Remove leading/trailing dashes
                return `product-${productKey}`;
            };
            
            supportTickets.forEach(ticket => {
                const newRow = document.createElement('tr');
                newRow.dataset.ticketId = ticket.id;
                
                let slackCell = '-';
                let notionCell = '-';
                
                if (ticket.slackUrl && ticket.slackUrl !== '' && ticket.slackUrl !== '-') {
                    slackCell = `<a href="${escapeHtml(ticket.slackUrl)}" target="_blank" class="escalation-link">üì± Slack</a>`;
                }
                
                if (ticket.notionUrl && ticket.notionUrl !== '' && ticket.notionUrl !== '-') {
                    notionCell = `<a href="${escapeHtml(ticket.notionUrl)}" target="_blank" class="escalation-link">üìù Notion</a>`;
                }

                const productClass = getProductClass(ticket.product);
                
                newRow.innerHTML = `
                    <td class="actions-cell">
                        <button class="action-btn" onclick="editRow(this)" title="Edit ticket">üìù</button>
                        <button class="action-btn delete-btn" onclick="deleteRow(this)" title="Delete ticket">üóëÔ∏è</button>
                    </td>
                    <td class="date-cell">${escapeHtml(ticket.dateCreated)}<span class="date-time">${escapeHtml(ticket.timeStamp)}</span></td>
                    <td class="ticket-number">${escapeHtml(ticket.ticketNo)}</td>
                    <td title="${escapeHtml(ticket.issue)}">${escapeHtml(ticket.issue)}</td>
                    <td><span class="status-badge ${statusClass[ticket.status] || 'status-open'}">${escapeHtml(ticket.status)}</span></td>
                    <td>${escapeHtml(ticket.agent) || '-'}</td>
                    <td><span class="product-badge ${productClass}">${escapeHtml(ticket.product)}</span></td>
                    <td><span class="queue-badge ${queueClass[ticket.queue] || 'queue-cplus'}">${escapeHtml(ticket.queue)}</span></td>
                    <td style="text-align: center; font-weight: 600; color: #1976d2; font-size: 13px;">${ticket.timesReplied}</td>
                    <td><span class="category-badge ${categoryClass[ticket.category] || 'category-question'}">${escapeHtml(ticket.category)}</span></td>
                    <td>${escapeHtml(ticket.department) || '-'}</td>
                    <td>${slackCell}</td>
                    <td>${notionCell}</td>
                    <td style="font-size: 12px; color: #5f6368; line-height: 1.4; white-space: pre-wrap;" title="${escapeHtml(ticket.comments || '-')}">${escapeHtml(ticket.comments) || '-'}</td>
                    <td class="date-cell">${escapeHtml(ticket.lastUpdated)}<span class="date-time">${escapeHtml(ticket.lastUpdatedTimeStamp)}</span></td>
                `;
                tbody.appendChild(newRow);
            });
        }

        function filterByStatus(status) {
            currentStatusFilter = status;
            const tbody = document.getElementById('ticketTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            document.getElementById('searchInput').value = '';
            
            document.querySelectorAll('.stat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            let activeStatId = '';
            switch(status) {
                case 'all': activeStatId = 'totalStat'; break;
                case 'open': activeStatId = 'openStat'; break;
                case 'pending': activeStatId = 'pendingStat'; break;
                case 'onhold': activeStatId = 'onHoldStat'; break;
                case 'resolved': activeStatId = 'resolvedStat'; break;
            }
            
            if (activeStatId) {
                document.getElementById(activeStatId).classList.add('active');
            }
            
            rows.forEach(row => {
                if (!row.dataset.ticketId) return;
                
                row.classList.remove('hidden');
                
                if (status === 'all') return;
                
                const statusBadge = row.querySelector('.status-badge');
                if (!statusBadge) return;
                
                const rowStatus = statusBadge.textContent.toLowerCase();
                let shouldShow = false;
                
                switch(status) {
                    case 'open': shouldShow = rowStatus === 'open'; break;
                    case 'pending': shouldShow = rowStatus === 'pending'; break;
                    case 'onhold': shouldShow = rowStatus.includes('hold') || rowStatus.includes('escalated'); break;
                    case 'resolved': shouldShow = rowStatus === 'resolved'; break;
                }
                
                if (!shouldShow) {
                    row.classList.add('hidden');
                }
            });
            
            updateStats();
        }

        function searchTickets() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            const tbody = document.getElementById('ticketTableBody');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            
            if (searchTerm && currentStatusFilter !== 'all') {
                currentStatusFilter = 'all';
                document.querySelectorAll('.stat-item').forEach(item => {
                    item.classList.remove('active');
                });
            }
            
            rows.forEach(row => {
                if (!row.dataset.ticketId) return;
                
                try {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 9) return;
                    
                    const searchableText = [
                        cells[2] ? cells[2].textContent : '',
                        cells[3] ? cells[3].textContent : '',
                        cells[4] ? cells[4].textContent : '',
                        cells[5] ? cells[5].textContent : '',
                        cells[6] ? cells[6].textContent : '',
                        cells[9] ? cells[9].textContent : ''
                    ].join(' ').toLowerCase();
                    
                    if (!searchTerm || searchableText.includes(searchTerm)) {
                        row.classList.remove('hidden');
                        row.style.display = '';
                    } else {
                        row.classList.add('hidden');
                        row.style.display = 'none';
                    }
                } catch (error) {
                    console.log('Error processing row search:', error);
                }
            });
            
            updateStats();
        }

        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            const tbody = document.getElementById('ticketTableBody');
            if (tbody) {
                const rows = tbody.querySelectorAll('tr');
                rows.forEach(row => {
                    row.classList.remove('hidden');
                    row.style.display = '';
                });
            }
            
            updateStats();
        }

        function updateStats() {
            const tbody = document.getElementById('ticketTableBody');
            const rows = tbody.querySelectorAll('tr:not(.hidden)');
            let total = 0;
            let open = 0, pending = 0, onHold = 0, resolved = 0, totalTimesReplied = 0;
            
            rows.forEach(row => {
                if (!row.dataset.ticketId) return;
                
                total++;
                const statusText = row.querySelector('.status-badge')?.textContent || '';
                const timesRepliedText = row.cells[8]?.textContent?.trim() || '0';
                const timesReplied = parseInt(timesRepliedText) || 0;
                
                totalTimesReplied += timesReplied;
                
                if (statusText === 'Open') open++;
                else if (statusText === 'Pending') pending++;
                else if (statusText.includes('Hold') || statusText.includes('Escalated')) onHold++;
                else if (statusText === 'Resolved') resolved++;
            });
            
            document.getElementById('totalTickets').textContent = total;
            document.getElementById('openTickets').textContent = open;
            document.getElementById('pendingTickets').textContent = pending;
            document.getElementById('onHoldTickets').textContent = onHold;
            document.getElementById('resolvedTickets').textContent = resolved;
            document.getElementById('totalTimesReplied').textContent = totalTimesReplied;
        }

        function checkDuplicateTicket() {
            const ticketNumber = document.getElementById('newTicketNumber').value;
            const duplicateWarning = document.getElementById('duplicateWarning');
            
            if (!ticketNumber) {
                duplicateWarning.classList.remove('show');
                return false;
            }
            
            const isDuplicate = supportTickets.some(ticket => ticket.ticketNo === ticketNumber);
            
            if (isDuplicate) {
                duplicateWarning.classList.add('show');
                return true;
            } else {
                duplicateWarning.classList.remove('show');
                return false;
            }
        }

        function toggleAddForm() {
            const form = document.getElementById('addRowForm');
            
            form.classList.toggle('active');
            
            if (form.classList.contains('active')) {
                document.getElementById('newTicketNumber').value = '';
                document.getElementById('newIssue').value = '';
                document.getElementById('newCategory').value = 'Question';
                document.getElementById('newProduct').value = '3rd Party Apps';
                document.getElementById('newQueue').value = 'C+';
                document.getElementById('newStatus').value = 'Open';
                document.getElementById('newAgent').value = '';
                document.getElementById('newTimesReplied').value = '1';
                document.getElementById('duplicateWarning').classList.remove('show');
                
                // Clear and hide escalation fields
                document.getElementById('newEscalatedBugFields').classList.remove('show');
                document.getElementById('newNotionUrl').value = '';
                document.getElementById('newSlackUrl').value = '';
                document.getElementById('newDepartment').value = '';
                
                document.getElementById('newTicketNumber').focus();
            }
        }

        async function addNewTicket() {
            const ticketNumber = document.getElementById('newTicketNumber').value.trim();
            const issue = document.getElementById('newIssue').value.trim();
            const category = document.getElementById('newCategory').value;
            const product = document.getElementById('newProduct').value;
            const queue = document.getElementById('newQueue').value;
            const status = document.getElementById('newStatus').value;
            const agent = document.getElementById('newAgent').value;
            const timesReplied = parseInt(document.getElementById('newTimesReplied').value) || 1;
            
            if (!ticketNumber || !issue) {
                alert('Please fill in Ticket No. and Issue');
                return;
            }
            
            if (checkDuplicateTicket()) {
                alert('This ticket number already exists! Please check the existing ticket or use a different number.');
                return;
            }
            
            // Check if escalation details are required
            let escalationData = null;
            if (status === 'On Hold Escalated (Bug)') {
                const notionUrl = document.getElementById('newNotionUrl').value.trim();
                const slackUrl = document.getElementById('newSlackUrl').value.trim();
                const department = document.getElementById('newDepartment').value;
                
                escalationData = {
                    notionUrl: notionUrl || null,
                    slackUrl: slackUrl || null,
                    department: department || null
                };
            }
            
            const submitBtn = document.getElementById('submitTicketBtn');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
                
                const today = new Date().toISOString().split('T')[0];
                const timeString = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: true});
                
                const ticketData = {
                    ticketNo: ticketNumber,
                    issue: issue,
                    status: status,
                    agent: agent || null,
                    product: product,
                    queue: queue,
                    timesReplied: timesReplied,
                    category: category,
                    department: escalationData ? escalationData.department : null,
                    slackUrl: escalationData ? escalationData.slackUrl : null,
                    notionUrl: escalationData ? escalationData.notionUrl : null,
                    comments: null,
                    dateCreated: today,
                    timeStamp: timeString,
                    lastUpdated: today,
                    lastUpdatedTimeStamp: timeString
                };
                
                await saveTicketToDatabase(ticketData);
                await loadTicketsFromDatabase();
                toggleAddForm();
                
            } catch (error) {
                console.error('Error adding ticket:', error);
                alert(`Failed to add ticket: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        async function editRow(button) {
            const row = button.closest('tr');
            const ticketId = row.dataset.ticketId;
            const cells = row.querySelectorAll('td');
            
            if (button.textContent === 'üìù') {
                button.textContent = '‚úÖ';
                button.title = 'Save changes';
                
                const deleteBtn = row.querySelector('.delete-btn');
                deleteBtn.disabled = true;
                
                const issueCell = cells[3];
                const agentCell = cells[5];
                const timesRepliedCell = cells[8];
                const commentsCell = cells[13];
                
                const originalIssue = issueCell.textContent.trim();
                const originalAgent = agentCell.textContent.trim();
                const originalTimesReplied = timesRepliedCell.textContent.trim();
                const originalComments = commentsCell.textContent.trim();
                
                // Get current ticket data for escalation fields
                const ticket = supportTickets.find(t => t.id == ticketId);
                const originalNotionUrl = ticket ? (ticket.notionUrl || '') : '';
                const originalSlackUrl = ticket ? (ticket.slackUrl || '') : '';
                const originalDepartment = ticket ? (ticket.department || '') : '';
                
                // Safely escape values for HTML attributes
                const escapedIssue = escapeHtml(originalIssue);
                const escapedComments = originalComments === '-' ? '' : escapeHtml(originalComments);
                const escapedNotionUrl = escapeHtml(originalNotionUrl);
                const escapedSlackUrl = escapeHtml(originalSlackUrl);
                
                issueCell.innerHTML = `<input type="text" class="editable-cell" value="${escapedIssue}" style="width: 100%; border: 2px solid #1a73e8;">`;
                timesRepliedCell.innerHTML = `<input type="number" class="editable-cell" value="${originalTimesReplied}" min="0" style="width: 100%; border: 2px solid #1a73e8; text-align: center;">`;
                commentsCell.innerHTML = `<textarea class="editable-cell" style="width: 100%; border: 2px solid #1a73e8; min-height: 60px;">${escapedComments}</textarea>`;
                
                const agentOptions = ['', 'Leonardo', 'Mariana', 'Medha', 'Natalia', 'Raphy', 'Roberto', 'Sam', 'William'];
                let agentSelect = '<select class="editable-cell" style="width: 100%; border: 2px solid #1a73e8;">';
                agentSelect += '<option value="">-- No Agent --</option>';
                agentOptions.slice(1).forEach(agent => {
                    agentSelect += `<option value="${agent}" ${agent === originalAgent ? 'selected' : ''}>${agent}</option>`;
                });
                agentSelect += '</select>';
                agentCell.innerHTML = agentSelect;
                
                const statusCell = cells[4];
                const originalStatus = statusCell.querySelector('.status-badge').textContent.trim();
                const statusOptions = ['Open', 'Pending', 'Resolved', 'On Hold (Asking Dev Team)', 'On Hold Escalated (Bug)', 'Escalated (CSM)', 'Misrouted'];
                let statusSelect = `<select class="editable-cell status-dropdown" style="width: 100%; border: 2px solid #1a73e8;" onchange="toggleEditEscalationFields('${ticketId}', this.value); applyStatusColor(this)" data-status="${originalStatus}">`;
                statusOptions.forEach(status => {
                    statusSelect += `<option value="${status}" ${status === originalStatus ? 'selected' : ''}>${status}</option>`;
                });
                statusSelect += '</select>';
                statusCell.innerHTML = statusSelect;
                
                // Apply initial color to the status dropdown
                setTimeout(() => {
                    const statusDropdown = statusCell.querySelector('.status-dropdown');
                    if (statusDropdown) {
                        applyStatusColor(statusDropdown);
                    }
                }, 0);
                
                // FIXED: Department edit field - now handles both escalated and regular modes properly
                const departmentCell = cells[10];
                const escalationFieldsId = 'editEscalationFields_' + ticketId;
                const showEscalationFields = originalStatus === 'On Hold Escalated (Bug)';
                
                // Create both regular department display and escalation edit fields
                departmentCell.innerHTML = `
                    <div id="${escalationFieldsId}" style="display: ${showEscalationFields ? 'block' : 'none'}; background: #fff3e0; padding: 10px; border-radius: 4px; border: 1px solid #ff9800;">
                        <div style="margin-bottom: 8px;">
                            <label style="display: block; font-size: 11px; font-weight: 600; color: #e65100; margin-bottom: 3px;">Department</label>
                            <select id="editDepartment_${ticketId}" style="width: 100%; padding: 4px; border: 1px solid #ff9800; border-radius: 3px; font-size: 11px;">
                                <option value="">-- Select --</option>
                                <option value="#feedback-cms" ${originalDepartment === '#feedback-cms' ? 'selected' : ''}>#feedback-cms</option>
                                <option value="#feedback-crm" ${originalDepartment === '#feedback-crm' ? 'selected' : ''}>#feedback-crm</option>
                                <option value="#feedback-design-systems" ${originalDepartment === '#feedback-design-systems' ? 'selected' : ''}>#feedback-design-systems</option>
                                <option value="#feedback-downtime" ${originalDepartment === '#feedback-downtime' ? 'selected' : ''}>#feedback-downtime</option>
                                <option value="#feedback-eh" ${originalDepartment === '#feedback-eh' ? 'selected' : ''}>#feedback-eh</option>
                                <option value="#feedback-growth" ${originalDepartment === '#feedback-growth' ? 'selected' : ''}>#feedback-growth</option>
                                <option value="#feedback-infra" ${originalDepartment === '#feedback-infra' ? 'selected' : ''}>#feedback-infra</option>
                                <option value="#feedback-ios" ${originalDepartment === '#feedback-ios' ? 'selected' : ''}>#feedback-ios</option>
                                <option value="#feedback-live" ${originalDepartment === '#feedback-live' ? 'selected' : ''}>#feedback-live</option>
                                <option value="#feedback-other" ${originalDepartment === '#feedback-other' ? 'selected' : ''}>#feedback-other</option>
                                <option value="#feedback-paywalls" ${originalDepartment === '#feedback-paywalls' ? 'selected' : ''}>#feedback-paywalls</option>
                                <option value="#feedback-react-native-apps" ${originalDepartment === '#feedback-react-native-apps' ? 'selected' : ''}>#feedback-react-native-apps</option>
                                <option value="#feedback-special-projects" ${originalDepartment === '#feedback-special-projects' ? 'selected' : ''}>#feedback-special-projects</option>
                                <option value="#p-analytics" ${originalDepartment === '#p-analytics' ? 'selected' : ''}>#p-analytics</option>
                                <option value="#feedback-api" ${originalDepartment === '#feedback-api' ? 'selected' : ''}>#feedback-api</option>
                                <option value="#p-api-billing" ${originalDepartment === '#p-api-billing' ? 'selected' : ''}>#p-api-billing</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: ${showEscalationFields ? 'none' : 'block'};">
                        <select id="editDepartmentRegular_${ticketId}" style="width: 100%; padding: 4px; border: 1px solid #1a73e8; border-radius: 3px; font-size: 11px;">
                            <option value="">-- Select --</option>
                            <option value="#feedback-cms" ${originalDepartment === '#feedback-cms' ? 'selected' : ''}>#feedback-cms</option>
                            <option value="#feedback-crm" ${originalDepartment === '#feedback-crm' ? 'selected' : ''}>#feedback-crm</option>
                            <option value="#feedback-design-systems" ${originalDepartment === '#feedback-design-systems' ? 'selected' : ''}>#feedback-design-systems</option>
                            <option value="#feedback-downtime" ${originalDepartment === '#feedback-downtime' ? 'selected' : ''}>#feedback-downtime</option>
                            <option value="#feedback-eh" ${originalDepartment === '#feedback-eh' ? 'selected' : ''}>#feedback-eh</option>
                            <option value="#feedback-growth" ${originalDepartment === '#feedback-growth' ? 'selected' : ''}>#feedback-growth</option>
                            <option value="#feedback-infra" ${originalDepartment === '#feedback-infra' ? 'selected' : ''}>#feedback-infra</option>
                            <option value="#feedback-ios" ${originalDepartment === '#feedback-ios' ? 'selected' : ''}>#feedback-ios</option>
                            <option value="#feedback-live" ${originalDepartment === '#feedback-live' ? 'selected' : ''}>#feedback-live</option>
                            <option value="#feedback-other" ${originalDepartment === '#feedback-other' ? 'selected' : ''}>#feedback-other</option>
                            <option value="#feedback-paywalls" ${originalDepartment === '#feedback-paywalls' ? 'selected' : ''}>#feedback-paywalls</option>
                            <option value="#feedback-react-native-apps" ${originalDepartment === '#feedback-react-native-apps' ? 'selected' : ''}>#feedback-react-native-apps</option>
                            <option value="#feedback-special-projects" ${originalDepartment === '#feedback-special-projects' ? 'selected' : ''}>#feedback-special-projects</option>
                            <option value="#p-analytics" ${originalDepartment === '#p-analytics' ? 'selected' : ''}>#p-analytics</option>
                            <option value="#feedback-api" ${originalDepartment === '#feedback-api' ? 'selected' : ''}>#feedback-api</option>
                            <option value="#p-api-billing" ${originalDepartment === '#p-api-billing' ? 'selected' : ''}>#p-api-billing</option>
                        </select>
                    </div>
                `;
                
                // Update Slack URL cell
                const slackCell = cells[11];
                slackCell.innerHTML = `
                    <div id="editSlackFields_${ticketId}" style="display: ${showEscalationFields ? 'block' : 'none'};">
                        <input type="url" id="editSlackUrl_${ticketId}" value="${escapedSlackUrl}" placeholder="Slack URL" style="width: 100%; padding: 4px; border: 1px solid #ff9800; border-radius: 3px; font-size: 11px;">
                    </div>
                    <div style="display: ${showEscalationFields ? 'none' : 'block'};">${originalSlackUrl ? `<a href="${escapedSlackUrl}" target="_blank" class="escalation-link">üì± Slack</a>` : '-'}</div>
                `;
                
                // Update Notion URL cell
                const notionCell = cells[12];
                notionCell.innerHTML = `
                    <div id="editNotionFields_${ticketId}" style="display: ${showEscalationFields ? 'block' : 'none'};">
                        <input type="url" id="editNotionUrl_${ticketId}" value="${escapedNotionUrl}" placeholder="Notion URL" style="width: 100%; padding: 4px; border: 1px solid #ff9800; border-radius: 3px; font-size: 11px;">
                    </div>
                    <div style="display: ${showEscalationFields ? 'none' : 'block'};">${originalNotionUrl ? `<a href="${escapedNotionUrl}" target="_blank" class="escalation-link">üìù Notion</a>` : '-'}</div>
                `;
                
                issueCell.querySelector('input').focus();
                row.classList.add('saving');
                
            } else {
                const issueInput = cells[3].querySelector('input');
                const statusSelect = cells[4].querySelector('select');
                const agentInput = cells[5].querySelector('select');
                const timesRepliedInput = cells[8].querySelector('input');
                const commentsInput = cells[13].querySelector('textarea');
                
                const newIssue = issueInput.value.trim();
                const newStatus = statusSelect.value;
                const newAgent = agentInput.value;
                const newTimesReplied = parseInt(timesRepliedInput.value) || 0;
                let newComments = commentsInput.value.trim() || null;
                
                if (!newIssue) {
                    alert('Issue description is required!');
                    return;
                }
                
                // FIXED: Get department value from the correct field based on status
                let newDepartment = null;
                let notionUrl = null;
                let slackUrl = null;
                
                if (newStatus === 'On Hold Escalated (Bug)') {
                    // Get escalation data from the escalation edit fields
                    const notionUrlInput = document.getElementById('editNotionUrl_' + ticketId);
                    const slackUrlInput = document.getElementById('editSlackUrl_' + ticketId);
                    const departmentInput = document.getElementById('editDepartment_' + ticketId);
                    
                    notionUrl = notionUrlInput ? (notionUrlInput.value.trim() || null) : null;
                    slackUrl = slackUrlInput ? (slackUrlInput.value.trim() || null) : null;
                    newDepartment = departmentInput ? (departmentInput.value || null) : null;
                    
                    console.log('Escalated mode - Department input found:', !!departmentInput);
                    console.log('Escalated mode - Department value:', newDepartment);
                } else {
                    // Get department from the regular department field
                    const departmentRegularInput = document.getElementById('editDepartmentRegular_' + ticketId);
                    newDepartment = departmentRegularInput ? (departmentRegularInput.value || null) : null;
                    
                    console.log('Regular mode - Department input found:', !!departmentRegularInput);
                    console.log('Regular mode - Department value:', newDepartment);
                }
                
                console.log('Final department value being saved:', newDepartment);
                
                try {
                    button.disabled = true;
                    
                    const now = new Date();
                    const today = now.toISOString().split('T')[0];
                    const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
                    
                    // Create update data object with explicit department assignment
                    const updateData = {
                        issue: newIssue,
                        status: newStatus,
                        agent: newAgent || null,
                        timesReplied: newTimesReplied,
                        comments: newComments,
                        department: newDepartment, // Direct assignment
                        slackUrl: slackUrl,
                        notionUrl: notionUrl,
                        lastUpdated: today,
                        lastUpdatedTimeStamp: timeString
                    };
                    
                    // Debug: Log the department specifically
                    console.log('Department in updateData:', updateData.department);
                    console.log('Update data object:', updateData);
                    
                    await updateTicketInDatabase(ticketId, updateData);
                    await loadTicketsFromDatabase();
                    
                } catch (error) {
                    console.error('Error updating ticket:', error);
                    alert(`Failed to update ticket: ${error.message}`);
                    await loadTicketsFromDatabase();
                } finally {
                    button.disabled = false;
                }
            }
        }

        async function deleteRow(button) {
            const row = button.closest('tr');
            const ticketId = row.dataset.ticketId;
            const ticketNo = row.cells[2].textContent.trim();
            
            if (!confirm(`Are you sure you want to delete ticket #${ticketNo}? This action cannot be undone.`)) {
                return;
            }
            
            try {
                button.disabled = true;
                row.classList.add('saving');
                
                await deleteTicketFromDatabase(ticketId);
                
                supportTickets = supportTickets.filter(ticket => ticket.id != ticketId);
                row.remove();
                updateStats();
                
            } catch (error) {
                console.error('Error deleting ticket:', error);
                alert(`Failed to delete ticket: ${error.message}`);
                row.classList.remove('saving');
                button.disabled = false;
            }
        }

        async function deleteAllRows() {
            if (supportTickets.length === 0) {
                alert('No tickets to delete.');
                return;
            }
            
            const confirmMessage = `Are you sure you want to delete ALL ${supportTickets.length} tickets?\n\nThis will permanently delete them from the database!\n\nType "DELETE ALL" to confirm:`;
            const userInput = prompt(confirmMessage);
            
            if (userInput !== 'DELETE ALL') {
                if (userInput !== null) {
                    alert('Deletion cancelled. You must type "DELETE ALL" exactly to confirm.');
                }
                return;
            }
            
            try {
                showSyncStatus('Deleting all tickets...', 'saving');
                
                for (const ticket of supportTickets) {
                    await fetch(`/api/tickets/${ticket.id}`, { method: 'DELETE' });
                }
                
                supportTickets = [];
                renderTicketsTable();
                updateStats();
                
                showSyncStatus('All tickets deleted successfully!', 'success');
                
            } catch (error) {
                console.error('Error deleting all tickets:', error);
                showSyncStatus(`Failed to delete all tickets: ${error.message}`, 'error');
                await loadTicketsFromDatabase();
            }
        }

        function exportData(format) {
            if (supportTickets.length === 0) {
                alert('No tickets to export.');
                return;
            }
            
            const visibleTickets = supportTickets.filter(ticket => {
                const row = document.querySelector(`tr[data-ticket-id="${ticket.id}"]`);
                return row && !row.classList.contains('hidden');
            });
            
            let csvContent = 'Date Created,Ticket No.,Issue,Status,Agent,Product,Queue,Times Replied,Category,Department,Slack URL,Notion URL,Comments,Last Updated\n';
            
            if (format === 'excel') {
                csvContent = '\uFEFF' + csvContent;
            }
            
            visibleTickets.forEach(ticket => {
                const issue = (ticket.issue || '').replace(/"/g, '""');
                const comments = (ticket.comments || '').replace(/"/g, '""');
                
                const rowData = [
                    ticket.dateCreated,
                    ticket.ticketNo,
                    `"${issue}"`,
                    ticket.status,
                    ticket.agent || '',
                    ticket.product,
                    ticket.queue,
                    ticket.timesReplied,
                    ticket.category,
                    ticket.department || '',
                    ticket.slackUrl || '',
                    ticket.notionUrl || '',
                    `"${comments}"`,
                    ticket.lastUpdated
                ];
                
                csvContent += rowData.join(',') + '\n';
            });
            
            const mimeType = format === 'excel' ? 'application/vnd.ms-excel;charset=utf-8;' : 'text/csv;charset=utf-8;';
            const fileExtension = format === 'excel' ? '.xlsx' : '.csv';
            
            const blob = new Blob([csvContent], { type: mimeType });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'support_tickets_' + new Date().toISOString().split('T')[0] + fileExtension);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            if (format === 'excel') {
                alert('Excel file exported successfully!');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await testConnection();
            if (isConnected) {
                await loadTicketsFromDatabase();
            } else {
                showError('Unable to connect to database. Please check that your server is running.');
            }
            
            // Initialize dropdown colors
            initializeDropdownColors();
        });

        // Auto-refresh every 30 seconds if connected
        setInterval(async () => {
            if (isConnected && !document.querySelector('.add-row-form.active')) {
                try {
                    await loadTicketsFromDatabase();
                } catch (error) {
                    console.log('Auto-refresh failed:', error);
                }
            }
        }, 30000);
    </script>
</body>
</html>